<!DOCTYPE html> <html lang="en" dir="auto"> <head><meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=no"> <meta name="description" content="Planning This section focuses on considerations to review when you plan your migration. Migration tools Migration Toolkit for Containers The Migrat..."> <meta name="revised" content="5c0780b69338e12110ef830cf64ea9376cc6fbec"> <meta name="author" content="Red Hat Communities of Practice"> <meta name="generator" content="jekyll-rtd-theme v2.0.10"><meta name="theme-color" content="#2980b9"> <title>Planning 路 OpenShift Migration Best Practices</title> <meta name="twitter:title" content="Planning 路 OpenShift Migration Best Practices"> <meta name="twitter:description" content="Planning This section focuses on considerations to review when you plan your migration. Migration tools Migration Toolkit for Containers The Migrat..."> <meta name="twitter:card" content="summary"> <meta name="twitter:site" content="@Red Hat Communities of Practice"> <meta name="twitter:url" content="/openshift-migration-best-practices/01-planning.html"> <meta name="twitter:creator" content="@jekyll-rtd-theme v2.0.10"> <meta property="og:title" content="Planning 路 OpenShift Migration Best Practices"> <meta property="og:description" content="Planning This section focuses on considerations to review when you plan your migration. Migration tools Migration Toolkit for Containers The Migrat..."> <meta property="og:locale" content="en"> <meta property="og:url" content="/openshift-migration-best-practices/01-planning.html"> <meta property="og:type" content="article"> <meta property="article:author" content="Red Hat Communities of Practice"> <meta property="article:published_time" content="2020-08-20T10:18:51-05:00"> <meta property="article:modified_time" content="2021-08-02T19:33:25-05:00"> <script type="application/ld+json"> { "@context": "https://schema.org", "@type": "Article", "mainEntityOfPage": { "@type": "WebPage", "@id": "/openshift-migration-best-practices/01-planning.html" }, "headline": "Planning 路 OpenShift Migration Best Practices", "image": [], "author": { "@type": "Person", "name": "Red Hat Communities of Practice" }, "datePublished": "2020-08-20T10:18:51-05:00", "dateModified": "2021-08-02T19:33:25-05:00", "publisher": { "@type": "Organization", "name": "Red Hat Communities of Practice", "logo": { "@type": "ImageObject", "url": "https://avatars.githubusercontent.com/u/21339385?v=4" } }, "description": "Planning This section focuses on considerations to review when you plan your migration. Migration tools Migration Toolkit for Containers The Migrat..." } </script> <link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="next" href="/openshift-migration-best-practices/02-cluster-health-checks.html"><link rel="canonical" href="/openshift-migration-best-practices/01-planning.html"><link rel="icon" type="image/svg+xml" href="/openshift-migration-best-practices/assets/images/favicon.svg"><link rel="icon" type="image/png" href="/openshift-migration-best-practices/assets/images/favicon-16x16.png" sizes="16x16"> <link rel="icon" type="image/png" href="/openshift-migration-best-practices/assets/images/favicon-32x32.png" sizes="32x32"> <link rel="icon" type="image/png" href="/openshift-migration-best-practices/assets/images/favicon-96x96.png" sizes="96x96"><link rel="mask-icon" href="/openshift-migration-best-practices/assets/images/favicon.svg" color="#2980b9"><link rel="apple-touch-icon" href="/openshift-migration-best-practices/assets/images/apple-touch-icon-300x300.jpg"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/css/theme.min.css"><script> window.ui = { title: "OpenShift Migration Best Practices", baseurl: "/openshift-migration-best-practices", i18n: { search_results: "Search Results", search_results_found: "Search finished, found # page(s) matching the search query.", search_results_not_found: "Your search did not match any documents, please make sure that all characters are spelled correctly!" } }; </script> </head> <body class="container"><div class="sidebar-wrap overflow-hidden"> <div class="sidebar height-full overflow-y-scroll overflow-x-hidden"> <div class="header d-flex flex-column p-3 text-center"> <div class="title pb-1"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/openshift-migration-best-practices/" title="Best practices for migrating from OpenShift 3 to 4"> <i class="fa fa-home"></i> OpenShift Migration Best Practices </a> </div> <span class="version"></span> <form class="search pt-2" action="/openshift-migration-best-practices/search.html" method="get" autocomplete="off"> <input class="form-control input-block input-sm" type="text" name="q" placeholder="Search docs..."> </form> </div> <div class="toctree py-2" data-spy="affix" role="navigation" aria-label="main navigation"> <ul> <li class="toc level-1 current" data-sort="" data-level="1"> <a class="d-flex flex-items-baseline current" href="/openshift-migration-best-practices/01-planning.html">Planning</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/openshift-migration-best-practices/02-cluster-health-checks.html">Cluster health checks</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/openshift-migration-best-practices/03-pre-migration-testing.html">Premigration testing</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/openshift-migration-best-practices/04-running-the-migration.html">Running the migration</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/openshift-migration-best-practices/05-troubleshooting.html">Troubleshooting</a> </li> <li class="toc level-1 " data-sort="" data-level="1"> <a class="d-flex flex-items-baseline " href="/openshift-migration-best-practices/06-post-migration-considerations.html">Postmigration considerations</a> </li> </ul> </div> </div> </div> <div class="content-wrap"> <div class="header d-flex flex-justify-between p-2 hide-lg hide-xl" aria-label="top navigation"> <button id="toggle" aria-label="Toggle menu" class="btn-octicon p-2 m-0 text-white" type="button"> <i class="fa fa-bars"></i> </button> <div class="title flex-1 d-flex flex-justify-center"> <a class="h4 no-underline py-1 px-2 rounded-1" href="/openshift-migration-best-practices/">OpenShift Migration Best Practices</a> </div> </div> <div class="content p-3 p-sm-5"> <div class="navigation-top d-flex flex-justify-between"> <ul class="breadcrumb" role="navigation" aria-label="breadcrumbs navigation"> <li class="breadcrumb-item"> <a class="no-underline" href="/openshift-migration-best-practices/" title="/"> <i class="fa fa-home"></i> </a> </li><li class="breadcrumb-item" aria-current="page">01-planning.md</li></ul> </a> </div> <hr> <div role="main" itemscope="itemscope" itemtype="https://schema.org/Article"> <div class="markdown-body" itemprop="articleBody"> <h1 id="planning">Planning</h1> <p>This section focuses on considerations to review when you plan your migration.</p> <h2 id="migration-tools">Migration tools</h2> <h3 id="migration-toolkit-for-containers">Migration Toolkit for Containers</h3> <p>The Migration Toolkit for Containers (MTC) migrates an application workload, including Kubernetes resources, data, and images, from an OpenShift 3 source cluster to an OpenShift 4 target cluster.</p> <p>MTC performs the migration in two stages:</p> <ol> <li>The application workload is backed up from the source cluster to object storage.</li> <li>The application workload is restored to the target cluster from object storage.</li> </ol> <p><strong>Migrating Kubernetes resources</strong></p> <p>MTC migrates all namespaced resources, including Custom Resources. MTC can dynamically discover all the API resources in each referenced namespace.</p> <p>MTC migrates some cluster-scoped resources. If a namespaced resource references a cluster-scoped resource, it is migrated. Migratable resources include persistent volumes (PVs) bound to a persistent volume claim, cluster role bindings, and security context constraints (SCCs).</p> <p><strong>Migrating persistent volume data</strong></p> <p>MTC has two options for migrating persistent volume data:</p> <ul> <li> <p><strong>Move</strong>: The PV definition is moved from the source cluster to the target cluster without touching the data. This is the fastest option.</p> </li> <li> <p><strong>Copy</strong>: MTC copies either a <em>snapshot</em> or the <em>file system</em> of the PV.</p> </li> </ul> <p>See <a href="./running-the-migration.md#pv-move">PV move</a> and <a href="./running-the-migration.md#pv-move">PV copy</a> for requirements and details.</p> <p><strong>Migrating internal images</strong></p> <p>Internal images created by S2I builds are migrated. Each image stream reference in a given namespace is copied to the internal registry of the target cluster.</p> <h4 id="when-to-use-mtc">When to use MTC</h4> <p>Ideally, you could migrate an application from one cluster to another by redeploying the application from a pipeline and perhaps copying the persistent volume data.</p> <p>However, this might not be possible in the real world. A running application on the cluster might experience unforeseen changes and, over a period of time, drift away from the initial deploy. MTC can handle scenarios where you are not certain what your namespace contains and you want to migrate all its contents to a new cluster.</p> <p>If you can redeploy your application from pipeline, that is the best option. If not, you should use MTC.</p> <h4 id="mtc-documentation">MTC documentation</h4> <ul> <li><a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/migrating-application-workloads-3-4.html#migration-prerequisites_migrating-3-4">Prerequisites</a></li> <li><a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/migrating-application-workloads-3-4.html#migration-understanding-cam_migrating-3-4">About MTC</a></li> <li><a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/migrating-application-workloads-3-4.html#migration-understanding-data-copy-methods_migrating-3-4">About data copy methods</a></li> </ul> <h2 id="migration-environment-considerations">Migration environment considerations</h2> <p>OpenShift 4 introduces architectural changes and enhancements. The procedures that you used to manage your OpenShift 3 cluster might not apply to OpenShift 4.</p> <p>You should review the following considerations:</p> <ul> <li>Important differences between OpenShift 3 and 4 and their impact on migration (<a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-differences-architecture">Architecture</a>, <a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-differences-install">Installation and update</a>)</li> <li>How stored data will be migrated for stateful applications (<a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-preparing-storage">Storage</a>)</li> <li>How much downtime your application can tolerate during migration (<a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-preparing-networking">Networking</a>)</li> <li>How traffic will be redirected during migration (<a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-preparing-logging">Logging</a>, <a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-preparing-security">Security</a>, <a href="https://docs.openshift.com/container-platform/4.7/migration/migrating_3_4/planning-migration-3-to-4.html#migration-preparing-monitoring">Monitoring</a>, <a href="#dns-considerations">DNS</a>)</li> </ul> <h2 id="dns-considerations">DNS considerations</h2> <p>In a typical migration scenario, the DNS domain of the OpenShift 4 target cluster is usually different from the OpenShift 3 source cluster. This implies that the migrated applications will be have new URLs.</p> <p>If the source cluster uses the base domain <strong>ocp3.example.com</strong> and if the default domain of the applications is <strong>*.apps.ocp3.example.com</strong>, unless special measures are taken, the target cluster must be deployed on a different domain to avoid conflicts: <strong>ocp4.example.com</strong>, with the default applications defined as <strong>*.apps.ocp4.example.com</strong>.</p> <p>An application that uses the URL <code class="language-plaintext highlighter-rouge notranslate">http://app1.apps.ocp3.example.com</code> in the source cluster will, after migration, use the URL <code class="language-plaintext highlighter-rouge notranslate">http://app1.apps.ocp4.example.com</code>. In most cases, this is not a desirable result. The application clients must discover the new URL and adapt to it, which may not be a trivial or convenient thing to do.</p> <p>If preserving the DNS domain of migrated applications is a requirement, several options are possible.</p> <p>Once an OpenShift 4 cluster has been installed, its default DNS domain cannot be changed for a number of reasons:</p> <ul> <li> <p>Creating a route without specifying the host name parameter will use the default DNS domain for the target cluster (<strong>*.apps.ocp4.example.com</strong>). This can cause confusion when deploying a new application, especially after applying any of the options described next to have the migrated applications in the original source DNS domain.</p> </li> <li> <p>Internal services provided by the cluster like the web console, open authentication, alert manager, and metrics will use the default DNS domain in their URLs. With the exception of the web console, these URLs cannot be easily changed.</p> </li> </ul> <h3 id="option-1-isolate-the-dns-domain-of-the-target-cluster-from-the-clients">Option 1: Isolate the DNS domain of the target cluster from the clients</h3> <p>To hide the OpenShift 4 DNS domain from the clients, a network element like an application load balancer or a reverse proxy is placed between the clients and the OpenShift 4 cluster.</p> <p>The applications are migrated from the source to the target cluster and receive a FQDN in the default DNS domain of the target cluster (app1.apps.ocp4.example.com).</p> <p>The original application FQDN (<strong>app1.apps.ocp3.example.com</strong>) is updated in the DNS server to return the IP address of the network device. The network device contains rules to send requests received for the application in the source domain to the load balancer in the target cluster, using the target cluster domain.</p> <div class="language-plaintext highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code>app1.apps.ocp3.example.com ---|reverse proxy|---&gt;  app1.apps.ocp4.example.com
</code></pre>  </div></div> <p>The applications can be migrated using any of the network strategies described in <a href="#network-traffic-migration-strategies">Network traffic migration strategies</a>.</p> <p>You can migrate one application at a time, creating a wildcard DNS record for the <strong>*.apps.ocp3.example.com</strong> domain that points to the IP address of the load balancer of the source cluster. You then create a specific DNS record for each application, which points to the IP address of the network device in front of the target cluster. Because a specific DNS record has higher priority than a wildcard record, no conflict arises when the application FQDN is resolved.</p> <p>Some additional considerations for this option are:</p> <ul> <li> <p>The network device must terminate all secure TLS connections. Otherwise, if the connections are passed through to the OpenShift load balancer, the FQDN of the target application will be exposed to the client and certificate errors will occur.</p> </li> <li> <p>The applications must support this configuration and they must not return links referencing the target cluster domain to the clients. If such links are leaked back to the client within the returned content, parts of the application may not load or work properly.</p> </li> </ul> <h3 id="option-2-set-up-the-target-cluster-to-accept-the-source-dns-domain">Option 2: Set up the target cluster to accept the source DNS domain</h3> <p>You can set up the target cluster to accept requests for migrated applications in the same DNS domain that was defined in the source cluster.</p> <ul> <li> <p>Non-secure (HTTP) access:</p> <ul> <li> <p>In order for the router in the default ingress controller of the target cluster to accept requests for applications in the source DNS domain (app1.apps.ocp3.example.com), you must create a route in the application's project for the host name that was used in the source cluster:</p> <div class="language-sh highlighter-rouge notranslate"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>oc expose svc app1-svc  <span class="nt">--hostname</span> app1.apps.ocp3.example.com <span class="se">\</span>
 <span class="nt">-n</span> app1-namespace
</code></pre>  </div> </div> <p>With this new route in place, any request for that FQDN will be accepted and sent to the corresponding application pods.</p> <p>When the application is migrated, a route is created in the target cluster domain (app1.apps.ocp4.example.com). The migrated application can be accessed using both of these host names.</p> </li> <li> <p>You must create a specific DNS record for the FQDN defined in the route host name parameter that points to the IP address of the default load balancer of the target cluster. Specific DNS records take priority over wildcard records.</p> </li> </ul> <p>The FQDN of the application will resolve to the load balancer of the target cluster. Requests for that FQDN will be accepted by the default ingress controller router because a route for that host name is exposed.</p> </li> <li> <p>Secure TLS access:</p> <p>If the application requires a TLS/HTTPS connection, an additional step is required after you have created the route and DNS records:</p> <ul> <li>Replace the <a href="https://docs.openshift.com/container-platform/4.7/security/certificates/replacing-default-ingress-certificate.html">x509 certificate of the default ingress controller</a> created during the installation process with a custom certificate that includes the wildcard DNS domains for both the source and target clusters in the Subject Alternative Name (SAN) field. The new certificate will be valid for securing connections made using either of the two DNS domains.</li> </ul> <p>The certificate must be updated when it approaches its expiration date.</p> </li> </ul> <h3 id="option-3-deploy-the-target-cluster-in-the-source-cluster-domain">Option 3: Deploy the target cluster in the source cluster domain</h3> <p>Depending on configuration and base DNS domain of the source OpenShift 3 cluster, it might be possible to deploy the target OpenShift 4 cluster in the same DNS domain as the source cluster, using a combination of specific and wildcard DNS entries and public and private DNS zones to avoid conflicts between the clusters.</p> <p>This option requires careful planning and execution. If it is a viable option, it produces the best results. After migrating the applications, no maintenance of custom certificates, DNS entries, or external network devices is required.</p> <p>Details about this option are beyond the scope of this document. Contact Red Hat Support for more information.</p> <h2 id="migration-workflows">Migration workflows</h2> <h3 id="mtc-workflow">MTC workflow</h3> <p>MTC migrates applications from OCP 3 to OCP 4 in production and non-production environments.</p> <p>The following diagram describes the MTC workflow:</p> <p><img src="./images/mtc-promotion-flow.png" alt="MTC-based" /></p> <h3 id="cicd-workflow">CI/CD workflow</h3> <p>A CI/CD pipeline deploys applications on OCP 4 production and non-production environments.</p> <p>The following diagram describes a CI/CD workflow:</p> <p><img src="./images/ci-cd-promotion-flow.png" alt="CI-CD-based" /></p> <h2 id="network-traffic-migration-strategies">Network traffic migration strategies</h2> <p>This section describes strategies for migrating network traffic for stateless applications.</p> <p>Each strategy is based on this scenario:</p> <ul> <li>Applications are deployed on the 4.x cluster.</li> <li>If necessary, the 4.x router default certificate includes the 3.x wildcard SAN.</li> <li>Each application adds an additional route with the 3.x host name.</li> <li>Optional: The route with the 3.x host name contains an appropriate certificate.</li> </ul> <h3 id="big-bang-migration">"Big Bang" migration</h3> <p>At migration, the 3.x wildcard DNS record is changed to point to the 4.x router virtual IP address (VIP).</p> <p><img src="./images/migration-strategy-bigbang.png" alt="BigBang" /></p> <h3 id="individual-applications">Individual applications</h3> <p>At migration, a new record is created for each application with the 3.x FQDN/host name pointing to the 4.x router VIP. This record takes precedence over the 3.x wildcard DNS record.</p> <p><img src="./images/migration-strategy-individual.png" alt="Individual" /></p> <h3 id="canary-style-migration-of-individual-applications">Canary-style migration of individual applications</h3> <p>A VIP/proxy with two back ends, the 3.x router VIP and the 4.x router VIP, is created for each application.</p> <p>At migration, a new record is created for each application with the 3.x FQDN/host name pointing to the VIP/proxy. This record takes precedence over the 3.x wildcard DNS record.</p> <p>The proxy entry for the application is configured to route <code class="language-plaintext highlighter-rouge notranslate">X</code>% of the traffic to the 3.x router VIP and (100-<code class="language-plaintext highlighter-rouge notranslate">X</code>)% of the traffic to the 4.x VIP.</p> <p><code class="language-plaintext highlighter-rouge notranslate">X</code> is gradually moved from <code class="language-plaintext highlighter-rouge notranslate">100</code> to <code class="language-plaintext highlighter-rouge notranslate">0</code>.</p> <p><img src="./images/migration-strategy-canary.png" alt="Canary" /></p> <h3 id="audience-based-migration-of-individual-applications">Audience-based migration of individual applications</h3> <p>A VIP/proxy with two back ends, the 3.x router VIP and the 4.x router VIP, is created for each application.</p> <p>At migration, a new record is created for each application with the 3.x FQDN/host name pointing to the VIP/proxy. This record takes precedence over the 3.x wildcard DNS record.</p> <p>The proxy entry for the application is configured to route traffic matching a given header pattern, for example, test customers, to the 4.x router VIP and the rest of the traffic to the 3.x VIP.</p> <p>Traffic is moved to the 4.x VIP in waves until all the traffic is on the 4.x VIP.</p> <p><img src="./images/migration-strategy-audience.png" alt="Audience" /></p> </div> </div> <div class="navigation-bottom d-flex flex-justify-between py-3" role="navigation" aria-label="footer navigation"> <div class="prev"></div> <div class="next"><a href="/openshift-migration-best-practices/02-cluster-health-checks.html" class="btn" title="Cluster health checks" accesskey="n" rel="next"> Next <i class="fa fa-arrow-circle-right"></i> </a></div> </div><hr> <div class="copyright text-center text-gray" role="contentinfo"> <i class="fa fa-copyright"></i> <span class="time">2020-2021,</span> <a class="text-gray" href="https://github.com/redhat-cop" rel="noreferrer" target="_blank">Red Hat Communities of Practice</a> Revision <a class="text-gray" href="https://github.com/redhat-cop/openshift-migration-best-practices/commit/5c0780b69338e12110ef830cf64ea9376cc6fbec" title="5c0780b69338e12110ef830cf64ea9376cc6fbec" rel="noreferrer" target="_blank">5c0780b</a> <br> <div class="generator"> Built with <a href="https://pages.github.com" rel="noreferrer" target="_blank" title="github-pages v209">GitHub Pages</a> using a <a href="https://github.com/rundocs/jekyll-rtd-theme" rel="noreferrer" target="_blank" title="jekyll-rtd-theme v2.0.10">theme</a> provided by <a href="https://rundocs.io" rel="noreferrer" target="_blank">RunDocs</a>. </div> </div> </div> </div> <div class="addons-wrap d-flex flex-column overflow-y-auto"> <div class="status d-flex flex-justify-between p-2"> <div class="title p-1"> <i class="fa fa-book"></i> OpenShift Migration Best Practices </div> <div class="branch p-1"> <span class="name"> gh-pages </span> <i class="fa fa-caret-down"></i> </div> </div> <div class="addons d-flex flex-column height-full p-2 d-none"> <dl> <dt>GitHub</dt> <dd> <a href="https://github.com/redhat-cop/openshift-migration-best-practices" title="Stars: 67"> <i class="fa fa-github"></i> Homepage </a> </dd> <dd> <a href="https://github.com/redhat-cop/openshift-migration-best-practices/issues" title="Open issues: 3"> <i class="fa fa-question-circle-o"></i> Issues </a> </dd> <dd> <a href="https://github.com/redhat-cop/openshift-migration-best-practices/zipball/gh-pages" title="Size: 4421 Kb"> <i class="fa fa-download"></i> Download </a> </dd> </dl> <hr> <div class="license f6 pb-2"> This <a href="/openshift-migration-best-practices/" title="OpenShift Migration Best Practices">Software</a> is under the terms of <a href="https://github.com/redhat-cop/openshift-migration-best-practices">The Unlicense</a>. </div> </div> </div> <script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/gh/rundocs/jekyll-rtd-theme@2.0.10/assets/js/theme.min.js"></script> </body> </html>